<div class="o_cp_controller">
    <div class="o_control_panel">
        <ol class="breadcrumb">
            <li class="active">
                <a [routerLink]="['/sms/campaign']">Quản lý chiến dịch </a>/ {{campaign ? campaign.name : ''}}
            </li>
        </ol>
        <div class="o_cp_searchview">
            <div class="o_searchview">
                <input type="text" class="o_searchview_input" placeholder="Tìm kiếm theo tên" [(ngModel)]="search"
                    (ngModelChange)="this.searchUpdate.next($event)" />
            </div>
        </div>
        <div class="o_cp_left">
            <div class="o_cp_buttons">
                <div class="o_form_buttons_view">
                </div>
            </div>
            <div class="o_cp_sidebar">
            </div>
        </div>
        <div class="o_cp_right">
        </div>
    </div>
</div>


<div class="o_content">
    <div class="pms-wrapper">
        <div class="pms-left border p-3">
            <div>
                <input type="radio" class="btn-check" id="waiting" [value]="'waiting'" [(ngModel)]="state"
                    (change)="changeState()">
                <label for="waiting" class="btn btn-sm rounded-right-0"
                    [ngClass]="state == 'waiting' ? 'btn-primary' : 'btn-outline-primary'">Chờ gửi</label>

                <input type="radio" class="btn-check" id="success" [value]="'success'" [(ngModel)]="state"
                    (change)="changeState()">
                <label for="success" class="btn btn-sm rounded-left-0"
                    [ngClass]="state == 'success' ? 'btn-primary' : 'btn-outline-primary'">Đã gửi</label>
            </div>
            <div class="border">
                <div class="o_cp_controller">
                    <div class="o_control_panel">
                        <div class="o_cp_t_left">
                            <button type="button" *ngIf="state=='waiting'" class="btn btn-danger btn-sm"
                                (click)="cancelSend()">
                                Hủy gửi
                            </button>
                            <app-tai-date-range-filter-dropdown *ngIf="state=='success'" title="Thời gian" [dateFrom]="dateFrom" [dateTo]="dateTo" 
                                (searchChange)="onSearchDateChange($event)">
                            </app-tai-date-range-filter-dropdown>
                            <kendo-combobox [class.d-none]="state!='success'" class="kendo-combobox-sm ml-2" placeholder="Brandname"
                                [data]="filteredSmsAccount" [textField]="'brandName'" [valueField]="'id'"
                                [filterable]="true" #smsAccountCbx (valueChange)="onChangeAccount($event)">
                            </kendo-combobox>
                        </div>
                        <div class="o_cp_t_right">
                            <input class="o_searchview_input o_searchview" placeholder="Tìm kiếm theo tên tin nhắn"
                                type="text" [(ngModel)]="search" (ngModelChange)="this.searchUpdate.next($event)">
                        </div>
                    </div>
                </div>
                <div class="o_content">
                    <kendo-grid [data]="gridData" [pageSize]="limit" [skip]="offset" [pageable]="true" [loading]="loading"
                        (pageChange)="pageChange($event)" [kendoGridSelectBy]="'id'" [selectedKeys]="selectedIds"
                        (cellClick)="cellClick($event.dataItem)">
                        <kendo-grid-checkbox-column *ngIf="state=='waiting'" showSelectAll="true" width="50">
                        </kendo-grid-checkbox-column>
                        <kendo-grid-column field="name" title="Tên tin nhắn">
                        </kendo-grid-column>
                        <kendo-grid-column field="brandName" title="Brandname">
                        </kendo-grid-column>
                        <kendo-grid-column field="countPartner" title="Tổng người nhận">
                        </kendo-grid-column>
                        <kendo-grid-column title="Thời gian tạo">
                            <ng-template kendoGridCellTemplate let-dataItem>
                                {{dataItem.dateCreated | date:'dd/MM/yyyy'}}
                            </ng-template>
                        </kendo-grid-column>
                        <kendo-grid-column title="Thời gian gửi">
                            <ng-template kendoGridCellTemplate let-dataItem>
                                {{dataItem.date | date:'dd/MM/yyyy'}}
                            </ng-template>
                        </kendo-grid-column>
                    </kendo-grid>
                </div>
            </div>

        </div>
        <div class="pms-right border p-3" [formGroup]="formGroup">
            <h4>{{campaign ? campaign.name : ''}}</h4>
            <table class="w-100">
                <tr>
                    <td class="o_td_label">
                        <label class="o_form_label">Kích hoạt chương trình</label>
                    </td>
                    <td class="o_td_value">
                        <div class="custom-control custom-switch">
                            <input [attr.disabled]="!isEdit ? '' : null" type="checkbox" class="custom-control-input"
                                formControlName="stateCheck" id="switchActiveCampaign">
                            <label class="custom-control-label" for="switchActiveCampaign"></label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="o_td_label">
                        <label class="o_form_label">Tên chiến dịch</label>
                    </td>
                    <td class="o_td_value">
                        <input [attr.disabled]="!isEdit ? '' : null" class="form-control" formControlName="name" />
                        <div *ngIf="f.name.errors && (f.name.touched || f.name.dirty)" class="text-danger">
                            <div *ngIf="f.name.errors.required">Nhập tên chiến dịch</div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="o_td_label">
                        <label class="o_form_label">Thời gian chạy</label>
                    </td>
                    <td class="o_td_value">
                        <div>
                            <input [attr.disabled]="!isEdit ? '' : null" type="radio" class="btn-check" id="unlimited"
                                value="unlimited" formControlName="typeDate">
                            <label for="unlimited" class="btn btn-sm rounded-right-0"
                                [ngClass]="getValueFormControl('typeDate') == 'unlimited' ? 'btn-primary' : 'btn-outline-primary'">
                                Vô thời hạn
                            </label>
                            <input [attr.disabled]="!isEdit ? '' : null" type="radio" class="btn-check" id="period"
                                value="period" formControlName="typeDate">
                            <label for="period" class="btn btn-sm rounded-left-0"
                                [ngClass]="getValueFormControl('typeDate') == 'period' ? 'btn-primary' : 'btn-outline-primary'">
                                Khoảng thời gian
                            </label>
                        </div>
                        <div class="d-flex align-items-center" *ngIf="getValueFormControl('typeDate') == 'period'">
                            <kendo-datepicker [attr.disabled]="!isEdit ? '' : null" class="w-fit-content"
                                formControlName="startDateObj">
                            </kendo-datepicker>
                            <div class="mx-2">đến</div>
                            <kendo-datepicker [attr.disabled]="!isEdit ? '' : null" class="w-fit-content"
                                formControlName="endDateObj">
                            </kendo-datepicker>
                            <div *ngIf="(f.startDateObj.errors || f.endDateObj.errors) && (f.startDateObj.touched || f.endDateObj.touched || f.startDateObj.dirty || f.endDateObj.dirty)"
                                class="text-danger">
                                <div *ngIf="f.startDateObj.errors.required || f.endDateObj.errors.required">Chọn
                                    thời
                                    gian chạy chiến dịch</div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="o_td_label">
                        <label class="o_form_label">Hạn mức gửi tin</label>
                    </td>
                    <td class="o_td_value">
                        <div class="d-flex align-items-center">
                            <kendo-numerictextbox style="width: 150px;" [attr.disabled]="!isEdit ? '' : null"
                                class="w-fit-content" [min]="0" [format]="'n0'" formControlName="limitMessage">
                            </kendo-numerictextbox>
                            <div class="mx-2">SMS</div>
                            <span class="text-primary t-tooltip" placement="right" ngbTooltip="0 là không giới hạn">
                                <i class="fas fa-exclamation-circle"></i>
                            </span>
                        </div>
                        <div *ngIf="f.limitMessage.errors && (f.limitMessage.touched || f.limitMessage.dirty)"
                            class="text-danger">
                            <div *ngIf="f.limitMessage.errors.required">Nhập hạn mức gửi tin</div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="o_td_label ">
                        <label class="o_form_label mt-2">Hạn mức còn lại</label>
                    </td>
                    <td class="o_td_value">
                        <span class="o_form_label" *ngIf="f.limitMessage.value==0">Không giới hạn</span>
                        <span class="o_form_label" *ngIf="f.limitMessage.value!=0">
                            {{campaign ? (f.limitMessage.value - campaign.totalMessage) : 0}}
                        </span>
                    </td>
                </tr>
            </table>
            <div class="float-right">
                <button class="btn btn-sm btn-primary"
                    *ngIf="!isEdit && campaign && (campaign.defaultType=='' || !campaign.defaultType)"
                    (click)="onEditCampaign()">Sửa</button>
                <button class="btn btn-sm btn-primary mr-2" *ngIf="isEdit" (click)="onSaveCampaign()">Lưu</button>
                <button class="btn btn-sm btn-secondary" *ngIf="isEdit" (click)="onClose()">Đóng</button>
            </div>
        </div>
    </div>


</div>