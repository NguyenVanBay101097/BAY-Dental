<div class="o_form_view o_form_editable" [formGroup]="formGroup">
    <div class="o_form_sheet_bg">
        <div class="o_form_statusbar">
            <div class="o_statusbar_buttons">
                <button type="button" class="btn btn-primary btn-sm" (click)="actionSend()"
                    *ngIf="['in_queue', 'done'].indexOf(messaging.state) === -1">
                    Gửi ngay
                </button>
                <button type="button" class="btn btn-primary btn-sm" (click)="actionSchedule()"
                    *ngIf="['in_queue', 'done'].indexOf(messaging.state) === -1">
                    Lên lịch
                </button>
                <button type="button" class="btn btn-primary btn-sm" (click)="actionCancel()"
                    *ngIf="messaging.state === 'in_queue'">
                    Hủy bỏ
                </button>
                <button type="button" class="btn btn-primary btn-sm" (click)="onSave()">
                    Lưu
                </button>
                <button type="button" class="btn btn-sm btn-light" *ngIf="id" (click)="createNew()">
                    Thêm mới
                </button>
            </div>
            <div class="o_statusbar_status o_field_widget o_readonly_modifier">
                <button [disabled]="messaging.state !== 'done'" class="btn o_arrow_button disabled"
                    [ngClass]="{'btn-primary': messaging.state === 'done', 'btn-secondary': messaging.state !== 'done'}"
                    type="button">
                    Đã gửi
                </button>
                <button [disabled]="messaging.state !== 'in_queue'" class="btn o_arrow_button disabled"
                    [ngClass]="{'btn-primary': messaging.state === 'in_queue', 'btn-secondary': messaging.state !== 'in_queue'}"
                    type="button">
                    Chờ gửi
                </button>
                <button [disabled]="messaging.state !== 'draft'" class="btn o_arrow_button disabled"
                    [ngClass]="{'btn-primary': messaging.state === 'draft', 'btn-secondary': messaging.state !== 'draft'}"
                    type="button">
                    Nháp
                </button>
            </div>
        </div>
        <div class="alert alert-info text-center" *ngIf="messaging.state == 'in_queue'" role="alert">
            <strong>
                <span>Tin nhắn được lên lịch gửi lúc </span>
                <span class="o_field_date o_field_widget o_readonly_modifier oe_inline">
                    {{messaging.scheduleDate | date : 'short'}}
                </span>.
            </strong>
        </div>
        <div class="o_form_sheet">
            <div class="o_not_full oe_button_box">
                <button type="button" (click)="action_view('sent')" class="btn oe_stat_button">
                    <i class="far fa-envelope o_button_icon"></i>
                    <div class="o_field_widget o_stat_info o_readonly_modifier">
                        <span class="o_stat_value">{{messaging.totalSent | number}}</span>
                        <span class="o_stat_text">Đã gửi</span>
                    </div>
                </button>
                <button type="button" (click)="action_view('delivered')" class="btn oe_stat_button">
                    <div class="o_field_percent_pie o_field_widget o_readonly_modifier">
                        <div class="o_pie">
                            <div class="o_mask" style="transform: rotate(180deg);"></div>
                            <div class="o_mask" style="transform: rotate(0deg);"></div>
                            <div class="o_pie_value">
                                {{100 * messaging.totalReceived / messaging.totalSent | number:'1.0-0'}}%
                            </div>
                        </div>
                        <span>{{messaging.totalReceived | number}} Đã nhận</span>
                    </div>
                </button>
                <button type="button" (click)="action_view('opened')" class="btn oe_stat_button">
                    <div class="o_field_percent_pie o_field_widget o_readonly_modifier" name="opened_ratio">
                        <div class="o_pie">
                            <div class="o_mask" style="transform: rotate(180deg);"></div>
                            <div class="o_mask" style="transform: rotate(0deg);"></div>
                            <div class="o_pie_value">
                                {{100 * messaging.totalOpened / messaging.totalSent | number:'1.0-0'}}%
                            </div>
                        </div>
                        <span>{{messaging.totalOpened | number}} Đã đọc</span>
                    </div>
                </button>
            </div>
            <div class="o_group">
                <table class="o_group o_inner_group">
                    <tbody>
                        <tr>
                            <td class="o_td_label">
                                <label class="o_form_label">Mô tả</label>
                            </td>
                            <td style="width:100%">
                                <input type="text" class="form-control" formControlName="name" />
                            </td>
                        </tr>
                        <tr>
                            <td class="o_td_label">
                                <label class="o_form_label">Nội dung</label>
                            </td>
                            <td style="width:100%">
                                <div class="position-relative" (clickOutside)=hideEmoji()>
                                    <textarea type="text" my-autosize charCount [limit]="640" class="form-control" id="textarea_mass"
                                        formControlName="content" (click)="selectArea($event)" (keyup)="selectArea($event)"

                                        (focus)="showEmoji()">
                                    </textarea>
                                    <div class="plugin-textarea dropdown position-absolute text-dark rounded border shadow-sm" style="z-index: 2;" *ngIf="emoji">
                                        <span class="px-1" data-toggle="dropdown">
                                            <i class="fas fa-laugh"></i>
                                        </span>
                                        <emoji-mart class="dropdown-menu p-0 border-0" (emojiSelect)="selectEmoji($event)"></emoji-mart>
                                        <span class="px-1">
                                            <i class="fas fa-user"></i>
                                        </span>
                                        <span class="px-1">{{num_CharLeft}}</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="o_td_label">
                                <label class="o_form_label">Khách hàng</label>
                            </td>
                            <td style="width:100%">
                                <span class="audience-filter-content rounded border">
                                    <span class="dropdown">
                                        <button type="button" class="audience-filter-item mr-2 btn btn-light btn-sm border"
                                            [attr.id]="selectedAudienceFilter_Item === item ? 'dropdownMenuButton': ''"
                                            [attr.data-toggle]="selectedAudienceFilter_Item === item ? 'dropdown': ''"
                                            aria-haspopup="true" aria-expanded="false"
                                            *ngFor="let item of listAudienceFilter_Items; index as i" 
                                            (click)="selectAudienceFilterItem(item, i)">
                                            <span class="drop-select">{{item.name}}</span>
                                            <span class="condition-select pl-1">{{convertFormulaType(item.formula_type)}}</span>
                                            <span class="value-select pl-1">
                                                <span *ngIf="!item.formula_display || item.formula_display === ''">{{item.formula_value}}</span>
                                                <span *ngIf="item.formula_display && item.formula_display !== ''">{{item.formula_display}}</span>
                                            </span>
                                            <span class="remove" (click)="deleteAudienceFilterItem(i)">
                                                <i class="fas fa-times pl-2"></i>
                                            </span>
                                        </button>
                                        <div class="dropdown-menu allow-focus" aria-labelledby="dropdownMenuButton">
                                            <table>
                                                <tr>
                                                    <td class="border-right p-0 align-top">
                                                        <button class="dropdown-item" 
                                                            [class.text-primary]="item === selectedFormula.type"
                                                            type="button" 
                                                            *ngFor="let item of selectedAudienceFilter_Item_Picker.formula_types"
                                                            (click)="selectFormulaType(item)">
                                                            {{convertFormulaType(item)}}
                                                        </button>
                                                    </td>
                                                    <td class="p-0 align-top">
                                                        <div class="px-2 pb-2" [class.d-none]="selectedAudienceFilter_Item_Picker.type !== 'Tag'">
                                                            <input class="form-control shadow-sm" id="inputFormulaValue_Tag" style="min-width: 200px;" #inputFormulaValue type="text" placeholder="Tìm kiếm.." myAutofocus
                                                                (input)="inputSearchTag = inputFormulaValue.value; this.searchTagUpdate.next(inputFormulaValue.value)">
                                                        </div>
                                                        <div class="px-2 pb-2" *ngIf="showButtonCreateTag">
                                                            <button class="btn btn-light btn-sm" type="button" (click)="createTag()">
                                                                Create Tag
                                                            </button>
                                                        </div>
                                                        <div class="px-2 pb-2" [class.d-none]="!selectedAudienceFilter_Item_Picker.inputbox">
                                                            <input class="form-control shadow-sm" id="inputFormulaValue_Input" style="min-width: 200px;" #inputFormulaValue type="text" placeholder="Nhập.." myAutofocus>
                                                            <div class="text-right mt-2">
                                                                <button type="button" class="btn btn-light btn-sm" (click)="cancelInputFormulaValue()">Hủy bỏ</button>
                                                                <button type="button" class="btn btn-primary btn-sm ml-1" (click)="saveInputFormulaValue(inputFormulaValue.value)">Lưu</button>
                                                            </div>
                                                        </div>
                                                        <div class="list-formula-value">
                                                            <button class="dropdown-item"
                                                                [class.text-primary]="item === selectedFormula.value"
                                                                type="button" 
                                                                *ngFor="let item of selectedAudienceFilter_Item_Picker.formula_values; index as i"
                                                                (click)="selectFormulaValue(item, i)">
                                                                <span *ngIf="selectedAudienceFilter_Item_Picker.formula_displays === null">{{item}}</span>
                                                                <span *ngIf="selectedAudienceFilter_Item_Picker.formula_displays !== null">{{selectedAudienceFilter_Item_Picker.formula_displays[i]}}</span>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </span>
                                    <span class="dropdown audience-filter-picker">
                                        <button type="button" class="audience-filter-open btn btn-light btn-sm"
                                            id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"
                                            (click)="clickDropdownButtonAudienceFilter()">
                                            + Thêm điều kiện lọc
                                        </button>
                                        <div class="dropdown-menu allow-focus" aria-labelledby="dropdownMenuButton">
                                            <div id="dropdown-item-audience-filter">
                                                <button class="dropdown-item" type="button"
                                                    *ngFor="let item of listAudienceFilter_Picker"
                                                    (click)="selectAudienceFilter(item)">
                                                    {{item.name}}
                                                </button>
                                            </div>
                                            <table *ngIf="selectedAudienceFilter_Picker">
                                                <tr>
                                                    <td colspan="2">
                                                        <b class="ml-2">{{selectedAudienceFilter_Picker.name}} : </b>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="border-right p-0 align-top">
                                                        <button class="dropdown-item" 
                                                            [class.text-primary]="item === selectedFormula.type"
                                                            type="button" 
                                                            *ngFor="let item of selectedAudienceFilter_Picker.formula_types"
                                                            (click)="selectFormulaType(item)">
                                                            {{convertFormulaType(item)}}
                                                        </button>
                                                    </td>
                                                    <td class="p-0 align-top">
                                                        <div class="px-2 pb-2" *ngIf="selectedAudienceFilter_Picker.type === 'Tag'">
                                                            <input class="form-control shadow-sm" style="min-width: 200px;" #inputFormulaValue type="text" placeholder="Tìm kiếm.." myAutofocus
                                                                (input)="inputSearchTag = inputFormulaValue.value; this.searchTagUpdate.next(inputFormulaValue.value)">
                                                        </div>
                                                        <div class="px-2 pb-2" *ngIf="showButtonCreateTag">
                                                            <button class="btn btn-light btn-sm" type="button" (click)="createTag()">
                                                                Create Tag
                                                            </button>
                                                        </div>
                                                        <div class="px-2 pb-2" *ngIf="selectedAudienceFilter_Picker.inputbox">
                                                            <input class="form-control shadow-sm" style="min-width: 200px;" #inputFormulaValue type="text" placeholder="Nhập.." myAutofocus>
                                                            <div class="text-right mt-2">
                                                                <button type="button" class="btn btn-light btn-sm" (click)="cancelInputFormulaValue()">Hủy bỏ</button>
                                                                <button type="button" class="btn btn-primary btn-sm ml-1" (click)="saveInputFormulaValue(inputFormulaValue.value)">Lưu</button>
                                                            </div>
                                                        </div>
                                                        <div class="list-formula-value">
                                                            <button class="dropdown-item"
                                                                [class.text-primary]="item === selectedFormula.value"
                                                                type="button" 
                                                                *ngFor="let item of selectedAudienceFilter_Picker.formula_values; index as i"
                                                                (click)="selectFormulaValue(item, i)">
                                                                <span *ngIf="selectedAudienceFilter_Picker.formula_displays === null">{{item}}</span>
                                                                <span *ngIf="selectedAudienceFilter_Picker.formula_displays !== null">{{selectedAudienceFilter_Picker.formula_displays[i]}}</span>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </span>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>